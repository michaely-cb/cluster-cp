# Cluster Management

This directory contains the code for cluster server.

## Prerequisites
* python 3.8.x (we have some compilation issues with python 3.10 on mac M1 chips)
* go 1.21.x (otherwise the build process will stuck at installing Go dependencies, eg. go install)
* protoc 3.19.x
* helm 3.8.x
* minikube 1.25.x

## Server

Cluster Server will be running in Kubernetes cluster. It is a gRPC service. The
service proto file is defined in `pb/cluster.proto`.

## Client

Cluster Client will be running on the client machine. It is a python client. This
library will be used in Framwork to submit WSJobs and retrieve statuses.

The Cluster Client code is located in `src/framework/appliance_client/src/cerebras/appliance/cluster`.

To smoke test the integration, type:
```
pytest tests/cluster_mgmt/test_003_cluster_client_integration/test_run.py::test_cluster_client --cbtag <...> --app-tag <...> --cbclient-whl <...>
```

## Unit Tests

To run the unit tests, type:

```
make test
```

## Build

To build the cluster-server, type:

```
make server
```

To build the docker image for the cluster-server, go to the parent `src` directory and type:

```
make docker-build
```

The `cluster-server` uses the `job-operator` client library. The docker build needs to
be able to access the client library code.

## Charts

We use helm charts to manage the deployment of cluster service. The helm charts
are stored in `server/charts` directory.

### Install helm

The instruction to install `helm` can be found [here](https://helm.sh/docs/intro/install/).

To install it on Mac:

```
brew install helm
```

To install it using scripts:
```
curl -fsSL -o get_helm.sh https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3
chmod 700 get_helm.sh
./get_helm.sh
```

### Deploy cluster-server service

Before deploying cluster-server service, load the images into the Kubernetes cluster.

In minikube, do the following:

```
minikube image load cluster-server.tar
```

`cluster-server.tar` is generated by the following:

```
docker save cluster-server:latest > cluster-server.tar
```

Use this command to deploy `cluster-server` service:

```
helm upgrade -f values.yaml cluster-server . --namespace job-operator --install --create-namespace
```

You should see `cluster-server` running in `job-operator` namespace, like this:

```
[ec2-user@ip-172-17-113-12 mnt]$ kubectl  get pod -n job-operator
NAMESPACE      NAME                                                       READY   STATUS             RESTARTS      AGE
job-operator     cluster-server-56d97cb5d9-c6d2c                         1/1     Running            0             2m7s
```

To uninstall `cluster-server`, type this command:

```
helm -n job-operator uninstall cluster-server
```

## Deploy ingress-ngnix

To allow cluster server being accessed outside Kubernetes cluster, we will use `ingress-ngnix`.

Use this command to install `ingress-ngnix` in Kubernetes:

```
helm upgrade --install ingress-nginx ingress-nginx \
  --repo https://kubernetes.github.io/ingress-nginx \
  --namespace ingress-nginx --create-namespace
```

Adding external ips to `ingress-nginx-controller` service:

```
kubectl -n ingress-nginx patch svc ingress-nginx-controller --patch "$(cat external-ips.yaml)"
```

The `external-ips.yaml` looks like this (IP addresses should be the Kubernetes master IPs):

```
spec:
  externalIPs:
    - 172.17.113.70
```

For minikube running on Macs, it is required to run:

```
minikube tunnel
```

To uninstall ingress-ngnix, type:

```
helm -n ingress-nginx uninstall ingress-nginx
```

## Ingress secret

Use these commands to generate the secrets for the `Ingress` resource for cluster-server:

```
openssl req -x509 -newkey rsa:4096 -sha256 -days 3650 -nodes \
  -keyout tls.key -out tls.crt -subj '/CN=cerebras.com' \
  -extensions san \
  -config <(echo '[req]'; echo 'distinguished_name=req';
            echo '[san]'; echo 'subjectAltName=DNS:*.cluster-server.cerebras.com,DNS:cluster-server.cerebras.com,DNS:cerebras.com')



kubectl create secret tls cluster-server-grpc-secret-v2 --key tls.key --cert tls.crt -n job-operator
```

To delete the secret:

```
kubectl delete secret cluster-server-grpc-secret-v2 -n job-operator
```


