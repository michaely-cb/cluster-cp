# PRE-CONFIG
! do the following steps in preconfig since for some unknown reason
! the sequence of 1/ remove mgmt config 2/ set vrf mgmt 3/ set mgmt config
! does not work all in post config but does work if it's split between the 2
interface mgmt1/1/1
  no ip address
  no ipv6 address
ip vrf management
  interface management
# POST-CONFIG
hostname ${switch_name}
! clear default login banner
no banner login
!
username admin password ${switch_sha} role sysadmin priv-lvl 15 password-expiry 0
!
ip vrf default
!
interface vlan${mgmt_vlan}
   no shutdown
   ip address ${switch_cidr}
   ip helper-address ${ip_helper_address}
   ip dhcp-relay source-interface vlan${mgmt_vlan}
!
interface loopback 0
   no shutdown
   ip address ${loopback_ip}/32
!
interface ethernet1/1/1
   no shutdown
   flowcontrol receive on
   switchport access vlan ${mgmt_vlan}

interface ethernet1/1/2
   no shutdown
   flowcontrol receive on
   switchport access vlan ${mgmt_vlan}

interface ethernet1/1/3
   no shutdown
   flowcontrol receive on
   switchport access vlan ${mgmt_vlan}

interface ethernet1/1/4
   no shutdown
   flowcontrol receive on
   switchport access vlan ${mgmt_vlan}

interface ethernet1/1/5
   no shutdown
   flowcontrol receive on
   switchport access vlan ${mgmt_vlan}

interface ethernet1/1/6
   no shutdown
   flowcontrol receive on
   switchport access vlan ${mgmt_vlan}

interface ethernet1/1/7
   no shutdown
   flowcontrol receive on
   switchport access vlan ${mgmt_vlan}

interface ethernet1/1/8
   no shutdown
   flowcontrol receive on
   switchport access vlan ${mgmt_vlan}

interface ethernet1/1/9
   no shutdown
   flowcontrol receive on
   switchport access vlan ${mgmt_vlan}

interface ethernet1/1/10
   no shutdown
   flowcontrol receive on
   switchport access vlan ${mgmt_vlan}

interface ethernet1/1/11
   no shutdown
   flowcontrol receive on
   switchport access vlan ${mgmt_vlan}

interface ethernet1/1/12
   no shutdown
   flowcontrol receive on
   switchport access vlan ${mgmt_vlan}

interface ethernet1/1/13
   no shutdown
   flowcontrol receive on
   switchport access vlan ${mgmt_vlan}

interface ethernet1/1/14
   no shutdown
   flowcontrol receive on
   switchport access vlan ${mgmt_vlan}

interface ethernet1/1/15
   no shutdown
   flowcontrol receive on
   switchport access vlan ${mgmt_vlan}

interface ethernet1/1/16
   no shutdown
   flowcontrol receive on
   switchport access vlan ${mgmt_vlan}

interface ethernet1/1/17
   no shutdown
   flowcontrol receive on
   switchport access vlan ${mgmt_vlan}

interface ethernet1/1/18
   no shutdown
   flowcontrol receive on
   switchport access vlan ${mgmt_vlan}

interface ethernet1/1/19
   no shutdown
   flowcontrol receive on
   switchport access vlan ${mgmt_vlan}

interface ethernet1/1/20
   no shutdown
   flowcontrol receive on
   switchport access vlan ${mgmt_vlan}

interface ethernet1/1/21
   no shutdown
   flowcontrol receive on
   switchport access vlan ${mgmt_vlan}

interface ethernet1/1/22
   no shutdown
   flowcontrol receive on
   switchport access vlan ${mgmt_vlan}

interface ethernet1/1/23
   no shutdown
   flowcontrol receive on
   switchport access vlan ${mgmt_vlan}

interface ethernet1/1/24
   no shutdown
   flowcontrol receive on
   switchport access vlan ${mgmt_vlan}

interface ethernet1/1/25
   no shutdown
   flowcontrol receive on
   switchport access vlan ${mgmt_vlan}

interface ethernet1/1/26
   no shutdown
   flowcontrol receive on
   switchport access vlan ${mgmt_vlan}

interface ethernet1/1/27
   no shutdown
   flowcontrol receive on
   switchport access vlan ${mgmt_vlan}

interface ethernet1/1/28
   no shutdown
   flowcontrol receive on
   switchport access vlan ${mgmt_vlan}

interface ethernet1/1/29
   no shutdown
   flowcontrol receive on
   switchport access vlan ${mgmt_vlan}

interface ethernet1/1/30
   no shutdown
   flowcontrol receive on
   switchport access vlan ${mgmt_vlan}

interface ethernet1/1/31
   no shutdown
   flowcontrol receive on
   switchport access vlan ${mgmt_vlan}

interface ethernet1/1/32
   no shutdown
   flowcontrol receive on
   switchport access vlan ${mgmt_vlan}

interface ethernet1/1/33
   no shutdown
   flowcontrol receive on
   switchport access vlan ${mgmt_vlan}

interface ethernet1/1/34
   no shutdown
   flowcontrol receive on
   switchport access vlan ${mgmt_vlan}

interface ethernet1/1/35
   no shutdown
   flowcontrol receive on
   switchport access vlan ${mgmt_vlan}

interface ethernet1/1/36
   no shutdown
   flowcontrol receive on
   switchport access vlan ${mgmt_vlan}

interface ethernet1/1/37
   no shutdown
   flowcontrol receive on
   switchport access vlan ${mgmt_vlan}

interface ethernet1/1/38
   switchport access vlan ${mgmt_vlan}
   no shutdown
   flowcontrol receive on

interface ethernet1/1/39
   no shutdown
   flowcontrol receive on
   switchport access vlan ${mgmt_vlan}

interface ethernet1/1/40
   no shutdown
   flowcontrol receive on
   switchport access vlan ${mgmt_vlan}

interface ethernet1/1/41
   no shutdown
   flowcontrol receive on
   switchport access vlan ${mgmt_vlan}

interface ethernet1/1/42
   no shutdown
   flowcontrol receive on
   switchport access vlan ${mgmt_vlan}

interface ethernet1/1/43
   no shutdown
   flowcontrol receive on
   switchport access vlan ${mgmt_vlan}

interface ethernet1/1/44
   no shutdown
   flowcontrol receive on
   switchport access vlan ${mgmt_vlan}

interface ethernet1/1/45
   no shutdown
   flowcontrol receive on
   switchport access vlan ${mgmt_vlan}

interface ethernet1/1/46
   no shutdown
   flowcontrol receive on
   switchport access vlan ${mgmt_vlan}

interface ethernet1/1/47
   no shutdown
   flowcontrol receive on
   switchport access vlan ${mgmt_vlan}

interface ethernet1/1/48
   no shutdown
   flowcontrol receive on
   switchport access vlan ${mgmt_vlan}

interface ethernet1/1/51
   description management node 10G
   switchport access vlan ${mgmt_vlan}

interface ethernet1/1/52
   description management node 10G
   switchport access vlan ${mgmt_vlan}

interface ethernet1/1/49
   description uplink to aggregate switch
   no switchport
   ! bogus IP allows routing of IPv4 addrs over an IPv6 unnumbered interface
   ip address 192.168.255.0/31
   ipv6 enable
   ipv6 address autoconfig
   ipv6 nd min-ra-interval 4
   ipv6 nd send-ra
!
interface ethernet1/1/50
   description uplink to aggregate switch
   no switchport
   ! bogus IP allows routing of IPv4 addrs over an IPv6 unnumbered interface
   ip address 192.168.255.2/31
   ipv6 enable
   ipv6 address autoconfig
   ipv6 nd min-ra-interval 4
   ipv6 nd send-ra
!
router bgp ${switch_asn}
 router-id ${loopback_ip}
 !
 address-family ipv4 unicast
  redistribute connected
 !
 template dynamic-bgp
  local-as ${local_asn}
  listen ${mgmt_subnet}
  remote-as ${asn_agg_0}
  remote-as ${asn_agg_1}
 !
 neighbor interface ethernet1/1/49
  no shutdown
  link-local-only-nexthop
 !
 neighbor interface ethernet1/1/50
  no shutdown
  link-local-only-nexthop
!

interface mgmt1/1/1
   no shutdown
   ip address dhcp

! TODO: setting a static IP doesn't seem to work through ZTD and must be done afterwards
! management route 0.0.0.0/0 ${switch_mgmt_gw}
! interface mgmt1/1/1
!    no shutdown
!    ip address ${switch_mgmt_cidr}
!