{
    "$schema": "https://json-schema.org/draft/2020-12/schema",
    "$id": "https://cerebras.net/cerebras_cluster_network_config_schema.json",
    "title": "Network Configuration Schema",
    "description": "JSON schema for Cerebras Cluster network configuration",
    "type": "object",
    "additionalProperties": false,
    "properties": {
        "name": {
            "description": "Name of the network configuration",
            "type": "string"
        },
        "description": {
            "description": "Description of the network configuration",
            "type": "string"
        },
        "notes": {
            "description": "List of notes on the network configuration",
            "type": "array",
            "items": {
                "type": "string"
            }
        },
        "cluster_data_vip": {
            "description": "VIP for cluster-mgmt API endpoint",
            "type": "object",
            "additionalProperties": false,
            "properties": {
                "vip": {
                    "$ref": "#/$defs/ip_interface"
                }
            }
        },
        "cluster_mgmt_vip": {
            "type": "object",
            "$comment": "Management VIP configuration. Should be configured for a multi-management node cluster in input.yaml. This is a pass-through for k8 configuration",
            "properties": {
                "router_asn": {
                    "$ref": "#/$defs/asn4",
                    "$comment": "ASN of the mgmt routing fabric. 'local ASN' configured on aggregate switches."
                },
                "node_asn": {
                    "$ref": "#/$defs/asn4",
                    "$comment": "ASN of the k8 controlplane nodes."
                },
                "vip": {
                    "$ref": "#/$defs/ip_interface"
                }
            },
            "required": ["router_asn", "node_asn", "vip"]
        },
        "clusters": {
            "description": "List of clusters",
            "type": "array",
            "uniqueItems": true,
            "items": {
                "$ref": "#/$defs/cluster"
            }
        },
        "environment": {
            "description": "Cluster environment",
            "type": "object",
            "additionalProperties": false,
            "properties": {
                "cluster_prefix": {
                    "$ref": "#/$defs/ip_network"
                },
                "subnet_pools": {
                    "type": "array",
                    "items": {
                        "ref": "#/$defs/subnet_pool"
                    }
                },
                "system_prefix": {
                    "$ref": "#/$defs/ip_network"
                },
                "gateway_index": {
                    "type": "integer"
                },
                "exterior_prefixes": {
                    "type": "array",
                    "uniqueItems": true,
                    "items": {
                        "$ref": "#/$defs/ip_network"
                    }
                },
                "exterior_nonpolicy_prefixes": {
                    "type": "array",
                    "uniqueItems": true,
                    "items": {
                        "$ref": "#/$defs/ip_network"
                    }
                },
                "cluster_asns": {
                    "type": "array",
                    "uniqueItems": true,
                    "items": {
                        "type": "object",
                        "additionalProperties": false,
                        "properties": {
                            "starting_asn": {
                                "$ref": "#/$defs/asn4"
                            },
                            "count": {
                                "type": "integer",
                                "min": 1
                            }
                        }
                    }
                },
                "overlay_prefixes": {
                    "type": "array",
                    "uniqueItems": true,
                    "items": {
                        "$ref": "#/$defs/ip_network"
                    }
                },
                "overlay_prefix_mask_size": {
                    "type": "integer"
                },
                "service_prefix": {
                    "$ref": "#/$defs/ip_network"
                },
                "cluster_data_vip_count": {
                    "type": "integer"
                },
                "topology": {
                    "type": "string"
                },
                "system_enable_dcqcn": {
                    "type": "boolean"
                },
                "vrf_name": {
                    "type": "string",
                    "default": "cs1data"
                }
            }
        },
        "reserved_subnet_pools": {
            "description": "Reserved subnet pools",
            "type": "array",
            "items": {
                "$ref": "#/$defs/subnet_pool"
            }
        },
        "tiers": {
            "type": "array",
            "uniqueItems": true,
            "items": {
                "$ref": "#/$defs/tier_allocation"
            }
        },
        "additional_extents": {
            "type": "array",
            "uniqueItems": true,
            "items": {
                "$ref": "#/$defs/additional_extent"
            }
        },
        "root_server": {
            "description": "The deployment root server",
            "type": "object",
            "additionalProperties": false,
            "properties": {
                "name": {
                    "type": "string"
                },
                "ip_address": {
                    "$ref": "#/$defs/ip_address"
                }
            }
        },
        "switches": {
            "description": "List of switches",
            "type": "array",
            "uniqueItems": true,
            "items": {
                "$ref": "#/$defs/switch"
            }
        },
        "exterior_switches": {
            "description": "List of switches outside the cluster",
            "type": "array",
            "uniqueItems": true,
            "items": {
                "$ref": "#/$defs/exterior_switch"
            }
        },
        "systems": {
            "description": "List of systems",
            "type": "array",
            "uniqueItems": true,
            "items": {
                "$ref": "#/$defs/system"
            }
        },
        "vips": {
            "description": "Information about VIP addresses",
            "type": "object",
            "additionalProperties": false,
            "properties": {
                "prefix": {
                    "description": "Prefix for VIPs",
                    "$ref": "#/$defs/ip_network"
                }
            }
        },
        "xconnect": {
            "description": "Information about cross connections",
            "type": "object",
            "additionalProperties": false,
            "properties": {
                "starting_prefix": {
                    "$ref": "#/$defs/ip_network"
                },
                "count": {
                    "type": "integer",
                    "min": 1
                },
                "connections": {
                    "type": "array",
                    "uniqueItems": true,
                    "items": {
                        "$ref": "#/$defs/cross_connection"
                    }
                }
            }
        },
        "exterior_connections": {
            "description": "Information about exterior connections",
            "type": "array",
            "uniqueItems": true,
            "items": {
                "$ref": "#/$defs/exterior_connection"
            }
        },
        "memoryx_nodes": {
            "description": "List of MemoryX nodes",
            "$ref": "#/$defs/nodes"
        },
        "activation_nodes": {
            "description": "List of activation nodes",
            "$ref": "#/$defs/nodes"
        },
        "swarmx_nodes": {
            "description": "List of SwarmX nodes",
            "$ref": "#/$defs/nodes"
        },
        "worker_nodes": {
            "description": "List of worker nodes",
            "$ref": "#/$defs/nodes"
        },
        "user_nodes": {
            "description": "List of user nodes",
            "$ref": "#/$defs/nodes"
        },
        "management_nodes": {
            "description": "List of management nodes",
            "$ref": "#/$defs/nodes"
        },
        "inferencedriver_nodes": {
            "description": "List of inference driver nodes",
            "$ref": "#/$defs/nodes"
        },
        "system_connections": {
            "description": "List of systems ports and their switch ports",
            "$ref": "#/$defs/system_connection"
        }
    },
    "required": [
        "name"
    ],
    "$defs": {
        "ip_network": {
            "type": "string",
            "format": "ip_network"
        },
        "ip_interface": {
            "type": "string",
            "format": "ip_interface"
        },
        "ip_address": {
            "type": "string",
            "format": "ip_address"
        },
        "asn4": {
            "type": [
                "integer",
                "string"
            ],
            "maximum": 4294967295,
            "format": "asn4"
        },
        "mtu": {
            "type": "integer",
            "minimum": 1500,
            "maximum": 9000
        },
        "node_sections": {
            "enum": [
                "memoryx_nodes",
                "swarmx_nodes",
                "worker_nodes",
                "user_nodes",
                "management_nodes"
            ]
        },
        "tier_names": {
            "enum": [
                "BR",
                "AW",
                "COMBINED",
                "L2",
                "LF",
                "SP"
            ]
        },
        "extent_categories": {
            "enum": [
                "AW",
                "BR",
                "LF",
                "SP",
                "xconnect",
                "vips"
            ]
        },
        "extent_keys": {
            "enum": [
                "starting_prefix",
                "system_starting_prefix",
                "swarmx_starting_prefix",
                "prefix"
            ]
        },
        "additional_extent": {
            "type": "object",
            "additionalProperties": false,
            "properties": {
                "category": {
                    "$ref": "#/$defs/extent_categories"
                },
                "key": {
                    "$ref": "#/$defs/extent_keys"
                },
                "starting_prefix": {
                    "$ref": "#/$defs/ip_network"
                },
                "count": {
                    "type": "integer",
                    "minimum": 1
                }
            }
        },
        "tier_allocation": {
            "type": "object",
            "additionalProperties": false,
            "properties": {
                "name": {
                    "$ref": "#/$defs/tier_names"
                },
                "starting_prefix": {
                    "$ref": "#/$defs/ip_network"
                },
                "count": {
                    "type": "integer",
                    "minimum": 1,
                    "default": 1
                },
                "virtual_physical": {
                    "$comment": "Total number of virtual and physical IPs",
                    "type": "integer",
                    "minimum": 0
                },
                "min_physical": {
                    "type": "integer",
                    "minimum": 0
                },
                "swarmx_virtual_physical": {
                    "$comment": "Total number of virtual and physical swarmx IPs",
                    "type": "integer",
                    "minimum": 0
                },
                "swarmx_min_physical": {
                    "type": "integer",
                    "minimum": 0
                },
                "system_starting_prefix": {
                    "$ref": "#/$defs/ip_network"
                },
                "swarmx_starting_prefix": {
                    "$ref": "#/$defs/ip_network"
                }
            },
            "required": [
                "name",
                "starting_prefix",
                "count"
            ]
        },
        "interface": {
            "type": "object",
            "additionalProperties": false,
            "properties": {
                "name": {
                    "type": "string"
                },
                "switch_name": {
                    "type": "string"
                },
                "switch_port": {
                    "type": "string"
                },
                "address": {
                    "$ref": "#/$defs/ip_interface"
                },
                "state": {
                    "type": "string",
                    "$comment": "Represents the link state of the interface"
                },
                "gbps": {
                    "type": "integer",
                    "$comment": "The sysfs reported speed of the interface in Gibps"
                }
            },
            "required": [
                "name"
            ]
        },
        "cross_connection": {
            "type": "object",
            "additionalProperties": false,
            "properties": {
                "name": {
                    "type": "string"
                },
                "prefix": {
                    "$ref": "#/$defs/ip_network"
                },
                "links": {
                    "type": "array",
                    "minItems": 2,
                    "maxItems": 2,
                    "items": {
                        "type": "object",
                        "additionalProperties": false,
                        "properties": {
                            "name": {
                                "type": "string"
                            },
                            "port": {
                                "type": "string"
                            }
                        }
                    }
                }
            },
            "required": [
                "name",
                "links"
            ]
        },
        "system_connection": {
            "type": "array",
            "additionalProperties": false,
            "items": {
                "type": "object",
                "additionalProperties": false,
                "properties": {
                    "switch_name": {
                        "type": "string"
                    },
                    "switch_port": {
                        "type": "string"
                    },
                    "system_name": {
                        "type": "string"
                    },
                    "system_port": {
                        "type": "string"
                    }
                }
            }
        },
        "exterior_endpoint": {
            "type": "object",
            "additionalProperties": false,
            "properties": {
                "switch_name": {
                    "type": "string"
                },
                "switch_port": {
                    "type": "string"
                },
                "address": {
                    "$ref": "#/$defs/ip_interface"
                }
            },
            "required": [
                "switch_name",
                "switch_port",
                "address"
            ]
        },
        "exterior_connection": {
            "type": "object",
            "additionalProperties": false,
            "properties": {
                "name": {
                    "type": "string"
                },
                "interior": {
                    "$ref": "#/$defs/exterior_endpoint"
                },
                "exterior": {
                    "$ref": "#/$defs/exterior_endpoint"
                }
            },
            "required": [
                "name",
                "interior",
                "exterior"
            ]
        },
        "subnet_pool": {
            "type": "object",
            "additionalProperties": false,
            "properties": {
                "subnets": {
                    "type": "array",
                    "description": "List of IPv4 subnets in CIDR notation",
                    "items": {
                        "type": "string",
                        "pattern": "^([0-9]{1,3}\\.){3}[0-9]{1,3}/[0-9]{1,2}$"
                    }
                },
                "permit_classes": {
                    "type": "array",
                    "description": "List of subnet classes that can use the range, empty/not-set = permit all",
                    "items": {
                        "type": "string",
                        "enum": [
                            "mx_vlan",
                            "sx_vlan",
                            "sy_vlan",
                            "xconnect",
                            "vip"
                        ]
                    },
                    "default": []
                },
                "description": {
                    "type": "string",
                    "description": "Human-readable description of the subnet pool",
                    "default": ""
                }
            },
            "required": [
                "subnets"
            ]
        },
        "node": {
            "title": "Node Schema",
            "description": "JSON schema for Cerebras Cluster node configuration",
            "type": "object",
            "additionalProperties": false,
            "properties": {
                "name": {
                    "type": "string"
                },
                "management_address": {
                    "$ref": "#/$defs/ip_address"
                },
                "rack": {
                    "type": "string"
                },
                "rack_unit": {
                    "type": "integer"
                },
                "stamp": {
                    "type": "string"
                },
                "interfaces": {
                    "type": "array",
                    "items": {
                        "$ref": "#/$defs/interface"
                    }
                },
                "nodegroup": {
                    "type": "integer"
                },
                "username": {
                    "type": "string"
                },
                "password": {
                    "type": "string"
                }
            },
            "required": [
                "name"
            ]
        },
        "nodes": {
            "type": "array",
            "uniqueItems": true,
            "items": {
                "$ref": "#/$defs/node"
            }
        },
        "system": {
            "title": "System Schema",
            "description": "JSON schema for Cerebras Cluster system configuration",
            "type": "object",
            "additionalProperties": false,
            "properties": {
                "name": {
                    "type": "string"
                },
                "default_hostname": {
                    "type": "string"
                },
                "management_address": {
                    "$refs": "#/$defs/ip_address"
                },
                "rack": {
                    "type": "string"
                },
                "rack_unit": {
                    "type": "integer"
                },
                "stamp": {
                    "type": "string"
                },
                "vip": {
                    "$ref": "#/$defs/ip_interface"
                },
                "system_vlan": {
                    "type": "string"
                },
                "interfaces": {
                    "type": "array",
                    "items": {
                        "$ref": "#/$defs/interface"
                    }
                },
                "ports": {
                    "type": "array",
                    "items": {
                        "type": "object",
                        "additionalProperties": false,
                        "properties": {
                            "mac": {
                                "type": "string"
                            },
                            "port_num": {
                                "type": "integer"
                            }
                        },
                        "required": [
                            "mac"
                        ]
                    }
                },
                "nodegroup": {
                    "type": "integer"
                },
                "model": {
                    "type": "string"
                },
                "version": {
                    "type": "string"
                }
            },
            "required": [
                "name"
            ]
        },
        "switch_port": {
            "type": "object",
            "additionalProperties": false,
            "properties": {
                "name": {
                    "type": "string",
                    "$comment": "Name of the interface"
                },
                "speed": {
                    "type": "integer",
                    "$comment": "Speed of the port in bits"
                }
            }
        },
        "switch": {
            "title": "Switch Schema",
            "description": "JSON schema for Cerebras Cluster switch configuration",
            "type": "object",
            "additionalProperties": false,
            "properties": {
                "name": {
                    "type": "string"
                },
                "management_address": {
                    "$ref": "#/$defs/ip_address"
                },
                "router_id": {
                    "$ref": "#/$defs/ip_address"
                },
                "address": {
                    "$ref": "#/$defs/ip_interface"
                },
                "system_vlan_address": {
                    "$ref": "#/$defs/ip_interface"
                },
                "swarmx_vlan_address": {
                    "$ref": "#/$defs/ip_interface"
                },
                "ports": {
                    "description": "List of switch ports",
                    "type": "array",
                    "uniqueItems": true,
                    "items": {
                        "$ref": "#/$defs/switch_port"
                    }
                },
                "mtu": {
                    "$refs": "#/$defs/mtu"
                },
                "vlan": {
                    "type": "integer"
                },
                "system_vlan": {
                    "type": "integer"
                },
                "swarmx_vlan": {
                    "type": "integer"
                },
                "model": {
                    "type": "string"
                },
                "prefix": {
                    "$ref": "#/$defs/ip_network"
                },
                "system_prefix": {
                    "$ref": "#/$defs/ip_network"
                },
                "swarmx_prefix": {
                    "$ref": "#/$defs/ip_network"
                },
                "provided_prefix": {
                    "$ref": "#/$defs/ip_network"
                },
                "provided_system_prefix": {
                    "$ref": "#/$defs/ip_network"
                },
                "provided_swarmx_prefix": {
                    "$ref": "#/$defs/ip_network"
                },
                "virtual_addrs": {
                    "type": "object",
                    "additionalProperties": false,
                    "properties": {
                        "starting_address": {
                            "$ref": "#/$defs/ip_interface"
                        },
                        "ending_address": {
                            "$ref": "#/$defs/ip_interface",
                            "$comment": "inclusive"
                        }
                    },
                    "required": [
                        "starting_address",
                        "ending_address"
                    ]
                },
                "swarmx_virtual_addrs": {
                    "type": "object",
                    "additionalProperties": false,
                    "properties": {
                        "starting_address": {
                            "$ref": "#/$defs/ip_interface"
                        },
                        "ending_address": {
                            "$ref": "#/$defs/ip_interface",
                            "$comment": "inclusive"
                        }
                    },
                    "required": [
                        "starting_address",
                        "ending_address"
                    ]
                },
                "asn": {
                    "$ref": "#/$defs/asn4"
                },
                "rack": {
                    "type": "string"
                },
                "rack_unit": {
                    "type": "integer"
                },
                "stamp": {
                    "type": "string"
                },
                "tier": {
                    "$ref": "#/$defs/tier_names"
                },
                "tier_pos": {
                    "type": "integer",
                    "minimum": 0
                },
                "vendor": {
                    "enum": [
                        "arista",
                        "hpe",
                        "dell",
                        "edgecore",
                        "juniper"
                    ]
                },
                "username": {
                    "type": "string"
                },
                "password": {
                    "type": "string"
                },
                "roce_status": {
                    "type": "string"
                },
                "system_bgp_status": {
                    "type": "string"
                },
                "firmware_version": {
                    "type": "string"
                }
            },
            "required": [
                "name",
                "vendor",
                "tier",
                "tier_pos"
            ]
        },
        "exterior_switch": {
            "title": "Exterior Switch Schema",
            "description": "JSON schema for Cerebras Cluster exterior switch configuration",
            "type": "object",
            "additionalProperties": false,
            "properties": {
                "name": {
                    "type": "string"
                },
                "management_address": {
                    "$ref": "#/$defs/ip_address"
                },
                "mtu": {
                    "$refs": "#/$defs/mtu"
                },
                "asn": {
                    "$ref": "#/$defs/asn4"
                },
                "vendor": {
                    "enum": [
                        "unknown",
                        "arista",
                        "hpe",
                        "dell",
                        "edgecore",
                        "juniper"
                    ]
                }
            },
            "required": [
                "name"
            ]
        },
        "cluster": {
            "type": "object",
            "additionalProperties": false,
            "properties": {
                "name": {
                    "type": "string"
                },
                "mgmt_network": {
                    "type": "object",
                    "additionalProperties": false,
                    "properties": {
                        "vip": {
                            "$comment": "management VIP for the cluster",
                            "$ref": "#/$defs/ip_interface"
                        },
                        "router_asn": {
                            "$comment": "ASN of the mgmt routing fabric. 'local ASN' configured on TOR switches.",
                            "$ref": "#/$defs/asn4"
                        },
                        "node_asn": {
                            "$comment": "ASN of the k8 controlplane nodes.",
                            "$ref": "#/$defs/asn4"
                        }
                    },
                    "required": [
                        "vip",
                        "router_asn",
                        "node_asn"
                    ]
                },
                "data_network": {
                    "type": "object",
                    "additionalProperties": false,
                    "properties": {
                        "vip": {
                            "$ref": "#/$defs/ip_interface"
                        },
                        "virtual_addr_index": {
                            "$comment": "Divides the switch's virtual address range into multiple ranges for different clusters by dividing the ragnes into equal sized parts and selecting this index from the resulting parts list",
                            "type": "integer",
                            "minimum": 0,
                            "maximum": 1
                        }
                    },
                    "required": [
                        "virtual_addr_index"
                    ]
                }
            },
            "required": [
                "name",
                "data_network"
            ]
        }
    }
}
